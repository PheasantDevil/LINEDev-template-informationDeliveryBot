# テストガイド

このドキュメントでは、LINE Botとの連携テストの手順を説明します。

## 📋 テスト項目

1. **ローカル環境でのWebhookサーバー起動テスト**
2. **LINE Botとの基本連携テスト**
3. **コマンド動作テスト**
4. **情報収集機能のテスト**（実装後）

---

## 1. ローカル環境でのWebhookサーバー起動テスト

### 1.1 環境変数の設定

`.env`ファイルに実際の値を設定：

```bash
LINE_CHANNEL_ACCESS_TOKEN=your_actual_token_here
LINE_CHANNEL_SECRET=your_actual_secret_here
PORT=5000
```

### 1.2 依存関係のインストール

```bash
python3 -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
```

### 1.3 サーバーの起動

```bash
python src/webhook_server.py
```

**期待される結果：**
- サーバーが`http://0.0.0.0:5000`で起動
- エラーメッセージが表示されない

### 1.4 ヘルスチェック

別のターミナルで：

```bash
curl http://localhost:5000/health
```

**期待される結果：**
- `OK`が返ってくる

---

## 2. LINE Botとの基本連携テスト

### 2.1 ngrokを使用したローカルWebhook設定

ローカル環境でWebhookをテストする場合、ngrokを使用してローカルサーバーを公開します。

#### ngrokのインストール

```bash
# macOS
brew install ngrok

# または公式サイトからダウンロード
# https://ngrok.com/download
```

#### ngrokの起動

```bash
ngrok http 5000
```

**出力例：**
```
Forwarding  https://xxxx-xxxx-xxxx.ngrok.io -> http://localhost:5000
```

#### LINE Developers ConsoleでWebhook URLを設定

1. LINE Developers Console > チャネル選択 > Messaging API設定
2. Webhook URL: `https://xxxx-xxxx-xxxx.ngrok.io/webhook`
3. 「検証」ボタンをクリック
4. 「Webhookの利用」をON
5. 「応答メッセージ」をOFF

### 2.2 友だち追加テスト

1. LINEアプリでBotを友だち追加
2. ウェルカムメッセージが表示されることを確認

**期待される結果：**
- ウェルカムメッセージが表示される
- コマンド一覧が表示される

---

## 3. コマンド動作テスト

### 3.1 ユーザー登録テスト

**テスト手順：**
1. Botに「登録」と送信

**期待される結果：**
- 「✅ 登録が完了しました！」メッセージが表示される
- コマンド一覧が表示される

**確認方法：**
```bash
# data/users.jsonを確認
cat data/users.json
```

### 3.2 カテゴリ購読テスト

**テスト手順：**
1. Botに「購読 AI」と送信

**期待される結果：**
- 「✅ 「AI」カテゴリを購読しました！」メッセージが表示される

**確認方法：**
```bash
# data/users.jsonを確認
cat data/users.json
# subscribed_categoriesに"AI"が含まれていることを確認
```

### 3.3 カテゴリ購読解除テスト

**テスト手順：**
1. Botに「購読解除 AI」と送信

**期待される結果：**
- 「✅ 「AI」カテゴリの購読を解除しました。」メッセージが表示される

### 3.4 サイト一覧表示テスト

**テスト手順：**
1. Botに「サイト一覧」と送信

**期待される結果：**
- 登録されているサイト一覧が表示される
- 初期データ（サンプルサイト）が表示される

### 3.5 ヘルプメッセージテスト

**テスト手順：**
1. Botに「ヘルプ」や「help」など、未定義のコマンドを送信

**期待される結果：**
- ヘルプメッセージが表示される
- コマンド一覧が表示される

---

## 4. エラーハンドリングテスト

### 4.1 未登録ユーザーの購読テスト

**テスト手順：**
1. 新しいLINEアカウントでBotを友だち追加
2. 登録せずに「購読 AI」と送信

**期待される結果：**
- 「❌ ユーザーが登録されていません。まず「登録」コマンドで登録してください。」メッセージが表示される

### 4.2 署名検証テスト

**テスト手順：**
1. `LINE_CHANNEL_SECRET`を間違った値に設定
2. Webhookを受信

**期待される結果：**
- サーバーログに「❌ 署名検証失敗」が表示される
- HTTP 400エラーが返される

---

## 5. サーバーログの確認

### 5.1 ログの確認方法

サーバーを起動しているターミナルで、以下のようなログが表示されます：

```
============================================================
Webhook受信
============================================================
Body長: 1234 bytes
Signature: xxxxx...
✓ LineNotifier初期化成功
✓ 署名検証成功

--- イベント 1/1 ---
タイプ: message
メッセージタイプ: text
▶ 受信メッセージ: '登録' (ユーザーID: Uxxxxx...)
  → ユーザー登録処理
✓ LINE Replyを送信しました

============================================================
Webhook処理完了
============================================================
```

### 5.2 エラーログの確認

エラーが発生した場合、詳細なエラーメッセージとスタックトレースが表示されます。

---

## 6. トラブルシューティング

### エラー: `LINE_CHANNEL_ACCESS_TOKEN が設定されていません`

**原因**: 環境変数が正しく読み込まれていない

**解決方法**:
- `.env`ファイルがプロジェクトルートにあるか確認
- 環境変数が正しく設定されているか確認
- `python-dotenv`がインストールされているか確認（`requirements.txt`に含まれています）

### Webhookが受信されない

**原因**: 
- Webhook URLが正しく設定されていない
- ngrokが起動していない（ローカル環境の場合）
- サーバーが起動していない

**解決方法**:
- LINE Developers ConsoleでWebhook URLを確認
- ngrokのURLが正しいか確認
- サーバーのログを確認

### 署名検証エラー

**原因**: チャネルシークレットが間違っている

**解決方法**:
- `.env`ファイルの`LINE_CHANNEL_SECRET`を確認
- LINE Developers Consoleでチャネルシークレットを再確認

---

## 7. テストチェックリスト

### 基本機能

- [ ] サーバーが正常に起動する
- [ ] ヘルスチェックエンドポイントが動作する
- [ ] 友だち追加時にウェルカムメッセージが表示される
- [ ] ユーザー登録が正常に動作する
- [ ] カテゴリ購読が正常に動作する
- [ ] カテゴリ購読解除が正常に動作する
- [ ] サイト一覧が正常に表示される
- [ ] ヘルプメッセージが正常に表示される

### エラーハンドリング

- [ ] 未登録ユーザーの購読が適切にエラー表示される
- [ ] 署名検証が正常に動作する
- [ ] エラーログが適切に出力される

---

**最終更新**: 2025-01-12

