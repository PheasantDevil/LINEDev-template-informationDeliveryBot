# サイト単位購読機能の提案

## 📋 背景

### 現在の実装
- **カテゴリベースの購読・配信**: 「購読 AI」のようにカテゴリ単位で購読
- カテゴリ全体の情報が配信される

### ユーザーのニーズ
- **サイト単位の購読・配信**: 「AI Weekly」のような特定の情報配信サービス単位で購読
- メール内容の概要を時短で確認するための配信
- カテゴリ全体ではなく、特定のサイトに焦点を当てたい

---

## 💡 提案: サイト単位購読機能の実装

### 実装方針

#### 1. **両方式の共存**（推奨）

カテゴリベースとサイトベースの両方をサポート：

```
カテゴリ購読: 「購読 AI」 → AIカテゴリ全体の情報を配信
サイト購読: 「サイト購読 ai_weekly」 → AI Weeklyのみの情報を配信
```

**メリット**:
- 既存ユーザーへの影響なし（後方互換性）
- ユーザーが選択できる柔軟性
- 段階的な移行が可能

---

## 🔧 実装内容

### 1. データ構造（既存・拡張）

**現在のユーザーデータ構造**:
```json
{
  "user_id": "Uxxxxx...",
  "subscribed_categories": ["AI"],  // カテゴリ購読（既存）
  "subscribed_sites": []  // サイト購読（フィールドは存在、実装は未対応）
}
```

**実装後**:
```json
{
  "user_id": "Uxxxxx...",
  "subscribed_categories": ["AI"],  // カテゴリ購読（既存）
  "subscribed_sites": ["ai_weekly", "drone_news_001"]  // サイト購読（新規実装）
}
```

---

### 2. UserManager の拡張

#### 追加メソッド

```python
# src/user_manager.py

def subscribe_site(self, user_id: str, site_id: str) -> bool:
    """サイトを購読"""
    # 実装

def unsubscribe_site(self, user_id: str, site_id: str) -> bool:
    """サイトの購読を解除"""
    # 実装

def get_subscribed_users_by_site(self, site_id: str) -> List[str]:
    """サイトを購読しているユーザーIDリストを取得"""
    # 実装
```

---

### 3. 配信ロジックの拡張

#### `collect_and_deliver.py` の変更

**現在の配信ロジック**:
```python
# カテゴリ単位で配信
for category, items in items_by_category.items():
    user_ids = user_manager.get_subscribed_users(category)
    # 配信
```

**拡張後**:
```python
# カテゴリ単位で配信（既存）
for category, items in items_by_category.items():
    user_ids = user_manager.get_subscribed_users(category)
    # 配信

# サイト単位で配信（新規）
for item in new_items:
    site_id = item.site_id
    user_ids = user_manager.get_subscribed_users_by_site(site_id)
    # 配信
```

**注意**: 同一ユーザーに重複配信しないよう、配信済みユーザーIDをトラッキング

---

### 4. LINE Bot コマンドの拡張

#### 追加コマンド

```
現在:
- 購読 [カテゴリ]      → カテゴリ購読
- 購読解除 [カテゴリ]  → カテゴリ購読解除

追加:
- サイト購読 [サイトID]  → サイト購読（例: サイト購読 ai_weekly）
- サイト購読解除 [サイトID] → サイト購読解除
- 購読一覧               → 購読状況の表示（カテゴリ + サイト）
```

#### コマンド例

```
ユーザー: サイト一覧
Bot: 
利用可能なサイト:
1. AI Weekly (ID: ai_weekly)
2. ドローン情報サイト (ID: drone_news_001)

ユーザー: サイト購読 ai_weekly
Bot: ✅ 「AI Weekly」を購読しました！

ユーザー: 購読一覧
Bot:
現在の購読状況:

【カテゴリ】
- AI

【サイト】
- AI Weekly (ai_weekly)
```

---

## 📊 配信優先度と重複防止

### 配信優先度

1. **サイト購読**: サイト単位で購読しているユーザーに優先配信
2. **カテゴリ購読**: カテゴリ単位で購読しているユーザーに配信

### 重複防止

同一ユーザーが両方購読している場合：
- サイト購読で配信済み → カテゴリ購読での配信はスキップ
- または、両方で配信（ユーザーの選択に応じて）

**推奨**: サイト購読を優先（重複を防ぐ）

---

## 🎯 実装ステップ

### 段階1: 基盤実装（1-2時間）

1. **UserManager の拡張**
   - `subscribe_site()` メソッドの実装
   - `unsubscribe_site()` メソッドの実装
   - `get_subscribed_users_by_site()` メソッドの実装

2. **配信ロジックの拡張**
   - `collect_and_deliver.py` の `_deliver_new_items()` を拡張
   - サイト単位配信の追加
   - 重複防止ロジックの実装

### 段階2: LINE Bot コマンドの拡張（1時間）

1. **コマンドハンドラの追加**
   - `handle_site_subscribe_command()` の実装
   - `handle_site_unsubscribe_command()` の実装
   - `handle_subscription_list_command()` の実装（既存の改善）

2. **コマンドパーサーの拡張**
   - `webhook_server.py` のコマンド処理を拡張

### 段階3: テストと動作確認（1時間）

1. **ユニットテスト**
   - UserManager の新メソッドのテスト

2. **統合テスト**
   - サイト購読・配信のE2Eテスト

---

## 📈 期待される効果

### ユーザー体験の向上

- ✅ **特定サイトへのフォーカス**: 必要な情報だけを購読
- ✅ **時短**: メール内容の概要を素早く確認
- ✅ **柔軟性**: カテゴリ購読とサイト購読を選択可能

### システムの拡張性

- ✅ **段階的な機能拡張**: カテゴリ購読を維持しながら新機能を追加
- ✅ **後方互換性**: 既存ユーザーへの影響なし
- ✅ **将来の拡張**: キーワード購読などへの拡張が容易

---

## 🔄 移行計画

### 既存ユーザーへの影響

- **なし**: カテゴリ購読機能は維持される
- 既存の購読はそのまま動作

### 新機能の提供

- サイト購読機能を追加で提供
- ユーザーが選択して使用可能

---

## 💭 検討事項

### 1. コマンドの設計

**案1**: 明確に分離
```
購読 AI              → カテゴリ購読
サイト購読 ai_weekly → サイト購読
```

**案2**: 自動判定
```
購読 AI              → カテゴリとして解釈
購読 ai_weekly       → サイトIDとして解釈（サイトIDが先にマッチ）
```

**推奨**: 案1（明確性のため）

### 2. 配信の重複

**案1**: サイト購読優先（重複なし）
- サイト購読で配信済み → カテゴリ購読では配信しない

**案2**: 両方配信（重複あり）
- サイト購読とカテゴリ購読の両方で配信

**推奨**: 案1（ユーザー体験のため）

---

## ✅ 実装判断

**結論**: サイト単位購読機能の実装を推奨

**理由**:
1. ユーザーのニーズに合致（メール概要の時短確認）
2. 既存機能との共存が可能（後方互換性）
3. 実装コストが適度（2-4時間程度）
4. 将来の拡張性が高い

---

**最終更新**: 2025-01-18

