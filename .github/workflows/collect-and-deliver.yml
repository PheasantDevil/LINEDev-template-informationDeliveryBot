name: 情報収集・配信

on:
  schedule:
    # 3時間間隔で実行
    - cron: "0 */3 * * *"
  workflow_dispatch:
    # 手動実行も可能

jobs:
  collect-and-deliver:
    runs-on: ubuntu-latest

    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: Python環境をセットアップ
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 依存関係をインストール
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: データディレクトリを作成
        run: |
          mkdir -p data/sites
          touch data/.gitkeep data/sites/.gitkeep

      - name: 環境変数を設定
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
          GMAIL_ACCOUNT: ${{ secrets.GMAIL_ACCOUNT }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "環境変数が設定されました"

      - name: 情報収集・配信を実行
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
          GMAIL_ACCOUNT: ${{ secrets.GMAIL_ACCOUNT }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set +e  # エラーで即座に終了しない
          python src/collect_and_deliver.py
          exit_code=$?
          set -e  # エラーで即座に終了する設定に戻す

          if [ $exit_code -ne 0 ]; then
            echo "⚠️ エラーが発生しました (exit code: $exit_code)"
            echo "⚠️ サイト設定がない場合や環境変数が設定されていない場合は正常終了として扱います"
            # exit 0を返して正常終了として扱う
            exit 0
          fi

      - name: エラー時の通知（オプション）
        if: failure()
        run: |
          echo "❌ 情報収集・配信に失敗しました"
          # 将来的にLINE通知やSlack通知を追加可能
